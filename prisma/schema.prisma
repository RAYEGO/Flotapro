generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  name               String
  ruc                String?             @db.VarChar(11)
  drivers            Driver[]
  freights           Freight[]
  fuels              Fuel[]
  maintenancePlans   MaintenancePlan[]
  maintenanceRecords MaintenanceRecord[]
  trucks             Truck[]
  users              User[]
}

model User {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  companyId    String
  email        String   @unique
  name         String?
  passwordHash String
  role         Role     @default(ADMIN)
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Truck {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  companyId          String
  placa              String
  marca              String
  modelo             String
  anio               Int
  tipo               String
  kilometrajeActual  Int
  estado             TruckStatus         @default(ACTIVO)
  modoOperacion      TruckOperationMode  @default(DIRECTO)
  montoPorVueltaDueno Decimal?           @db.Decimal(12, 2)
  drivers            Driver[]
  freights           Freight[]
  fuels              Fuel[]
  maintenancePlans   MaintenancePlan[]
  maintenanceRecords MaintenanceRecord[]
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, placa])
  @@index([companyId, estado])
}

model Driver {
  id               String    @id @default(cuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  companyId        String
  nombre           String
  dni              String    @db.VarChar(8)
  licencia         String
  fechaVencimiento DateTime
  telefono         String?
  truckId          String?
  company          Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  truck            Truck?    @relation(fields: [truckId], references: [id])
  freights         Freight[]
  fuels            Fuel[]

  @@unique([companyId, dni])
  @@index([companyId, truckId])
}

model Freight {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  companyId   String
  truckId     String
  driverId    String
  fecha       DateTime
  cliente     String
  origen      String
  destino     String
  ingreso     Decimal       @db.Decimal(12, 2)
  peajes      Decimal       @default(0) @db.Decimal(12, 2)
  viaticos    Decimal       @default(0) @db.Decimal(12, 2)
  otrosGastos Decimal       @default(0) @db.Decimal(12, 2)
  ganancia    Decimal       @db.Decimal(12, 2)
  tipoModelo  FreightModelType @default(DUENO_PAGA)
  montoAcordado Decimal     @default(0) @db.Decimal(12, 2)
  estado      FreightStatus @default(PENDIENTE)
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  driver      Driver        @relation(fields: [driverId], references: [id])
  truck       Truck         @relation(fields: [truckId], references: [id])

  @@index([companyId, fecha])
  @@index([companyId, truckId])
  @@index([companyId, driverId])
}

model Fuel {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  companyId      String
  truckId        String
  driverId       String
  fecha          DateTime
  kilometraje    Int
  galones        Decimal  @db.Decimal(10, 3)
  precioPorGalon Decimal  @db.Decimal(12, 3)
  total          Decimal  @db.Decimal(12, 2)
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  driver         Driver   @relation(fields: [driverId], references: [id])
  truck          Truck    @relation(fields: [truckId], references: [id])

  @@index([companyId, fecha])
  @@index([companyId, truckId])
  @@index([companyId, driverId])
}

model MaintenancePlan {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  companyId        String
  truckId          String
  tipo             String
  cadaKm           Int
  ultimoServicioKm Int
  proximoKm        Int
  activo           Boolean  @default(true)
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  truck            Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)

  @@index([companyId, truckId, activo])
}

model MaintenanceRecord {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  companyId   String
  truckId     String
  fecha       DateTime
  tipo        String
  kilometraje Int
  costo       Decimal  @db.Decimal(12, 2)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  truck       Truck    @relation(fields: [truckId], references: [id])

  @@index([companyId, fecha])
  @@index([companyId, truckId])
}

enum Role {
  ADMIN
  USER
}

enum TruckStatus {
  ACTIVO
  INACTIVO
  TALLER
  VENDIDO
}

enum FreightStatus {
  PENDIENTE
  COMPLETADO
  ANULADO
}

enum TruckOperationMode {
  DIRECTO
  ALQUILER
}

enum FreightModelType {
  DUENO_PAGA
  CHOFER_PAGA
}
