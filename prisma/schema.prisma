generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  name               String
  ruc                String?             @db.VarChar(11)
  clients            Client[]
  drivers            Driver[]
  freights           Freight[]
  freightExpenses    FreightExpense[]
  fuels              Fuel[]
  maintenancePlans   MaintenancePlan[]
  maintenanceRecords MaintenanceRecord[]
  operationalPoints  OperationalPoint[]
  trucks             Truck[]
  users              User[]
}

model User {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  companyId    String
  email        String   @unique
  name         String?
  passwordHash String
  role         Role     @default(ADMIN)
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model Truck {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  companyId          String
  placa              String
  marca              String
  modelo             String
  anio               Int
  tipo               String
  kilometrajeActual  Int
  estado             TruckStatus         @default(ACTIVO)
  modoOperacion      TruckOperationMode  @default(DIRECTO)
  tipoPago           TruckPaymentType    @default(VUELTA)
  montoPorVueltaDueno Decimal?           @db.Decimal(12, 2)
  modeloPago         FreightModelType    @default(DUENO_PAGA)
  tipoCalculo        FreightCalcType     @default(VIAJE)
  montoBase          Decimal             @default(0) @db.Decimal(12, 2)
  drivers            Driver[]
  freights           Freight[]
  fuels              Fuel[]
  maintenancePlans   MaintenancePlan[]
  maintenanceRecords MaintenanceRecord[]
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, placa])
  @@index([companyId, estado])
}

model Driver {
  id               String    @id @default(cuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  companyId        String
  nombre           String
  dni              String    @db.VarChar(8)
  licencia         String
  fechaVencimiento DateTime
  telefono         String?
  truckId          String?
  company          Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  truck            Truck?    @relation(fields: [truckId], references: [id])
  freights         Freight[]
  fuels            Fuel[]

  @@unique([companyId, dni])
  @@index([companyId, truckId])
}

model Client {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  companyId      String
  nombreComercial String
  razonSocial    String?
  ruc            String?      @db.VarChar(11)
  tipo           ClientType   @default(EMPRESA)
  telefono       String
  correo         String
  estado         ClientStatus @default(ACTIVO)
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  operationalPoints OperationalPoint[]
  freights       Freight[]

  @@index([companyId, estado])
  @@index([companyId, tipo])
}

model Region {
  id                Int                @id
  nombre            String
  provinces         Province[]
  operationalPoints OperationalPoint[]

  @@index([nombre])
}

model Province {
  id                Int                @id
  nombre            String
  regionId          Int
  region            Region             @relation(fields: [regionId], references: [id], onDelete: Restrict)
  districts         District[]
  operationalPoints OperationalPoint[]

  @@index([regionId])
  @@index([nombre])
}

model District {
  id                Int                @id
  nombre            String
  provinceId        Int
  province          Province           @relation(fields: [provinceId], references: [id], onDelete: Restrict)
  operationalPoints OperationalPoint[]

  @@index([provinceId])
  @@index([nombre])
}

model OperationalPoint {
  id            String                @id @default(cuid())
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  companyId     String
  clienteId     String?
  nombre        String
  tipo          OperationalPointType  @default(OTRO)
  direccion     String
  ciudad        String
  departamento  String
  distrito      String?
  regionId      Int?
  provinceId    Int?
  districtId    Int?
  latitud       Decimal?              @db.Decimal(9, 6)
  longitud      Decimal?              @db.Decimal(9, 6)
  linkGoogleMaps String?
  referencia    String?
  company       Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cliente       Client?               @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  region        Region?               @relation(fields: [regionId], references: [id], onDelete: SetNull)
  province      Province?             @relation(fields: [provinceId], references: [id], onDelete: SetNull)
  district      District?             @relation(fields: [districtId], references: [id], onDelete: SetNull)
  freightsOrigen Freight[]            @relation("FreightOriginPoint")
  freightsDestino Freight[]           @relation("FreightDestinationPoint")

  @@index([companyId, tipo])
  @@index([companyId, clienteId])
  @@index([regionId])
  @@index([provinceId])
  @@index([districtId])
}

model Freight {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  companyId   String
  truckId     String
  customerId  String?
  originPointId String?
  destinationPointId String?
  driverId    String
  fecha       DateTime
  cliente     String
  origen      String
  destino     String
  ingreso     Decimal       @db.Decimal(12, 2)
  peajes      Decimal       @default(0) @db.Decimal(12, 2)
  viaticos    Decimal       @default(0) @db.Decimal(12, 2)
  otrosGastos Decimal       @default(0) @db.Decimal(12, 2)
  ganancia    Decimal       @db.Decimal(12, 2)
  tipoModelo  FreightModelType @default(DUENO_PAGA)
  montoAcordado Decimal     @default(0) @db.Decimal(12, 2)
  tipoCalculo FreightCalcType @default(VIAJE)
  montoBase   Decimal        @default(0) @db.Decimal(12, 2)
  montoCalculado Decimal     @default(0) @db.Decimal(12, 2)
  usarMontoPersonalizado Boolean @default(false)
  montoPersonalizado Decimal? @db.Decimal(12, 2)
  montoFinal Decimal         @default(0) @db.Decimal(12, 2)
  direccionPago PaymentDirection @default(POR_PAGAR)
  estado      FreightStatus @default(PENDIENTE)
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  driver      Driver        @relation(fields: [driverId], references: [id])
  truck       Truck         @relation(fields: [truckId], references: [id])
  customer    Client?       @relation(fields: [customerId], references: [id], onDelete: SetNull)
  originPoint OperationalPoint? @relation("FreightOriginPoint", fields: [originPointId], references: [id], onDelete: SetNull)
  destinationPoint OperationalPoint? @relation("FreightDestinationPoint", fields: [destinationPointId], references: [id], onDelete: SetNull)
  expenses    FreightExpense[]

  @@index([companyId, fecha])
  @@index([companyId, truckId])
  @@index([companyId, driverId])
  @@index([companyId, customerId])
  @@index([companyId, originPointId])
  @@index([companyId, destinationPointId])
}

model FreightExpense {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  companyId String
  freightId String
  fecha     DateTime
  concepto  String
  monto     Decimal  @db.Decimal(12, 2)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  freight   Freight  @relation(fields: [freightId], references: [id], onDelete: Cascade)

  @@index([companyId, fecha])
  @@index([companyId, freightId])
}

model Fuel {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  companyId      String
  truckId        String
  driverId       String
  fecha          DateTime
  kilometraje    Int
  galones        Decimal  @db.Decimal(10, 3)
  precioPorGalon Decimal  @db.Decimal(12, 3)
  total          Decimal  @db.Decimal(12, 2)
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  driver         Driver   @relation(fields: [driverId], references: [id])
  truck          Truck    @relation(fields: [truckId], references: [id])

  @@index([companyId, fecha])
  @@index([companyId, truckId])
  @@index([companyId, driverId])
}

model MaintenancePlan {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  companyId        String
  truckId          String
  tipo             String
  cadaKm           Int
  ultimoServicioKm Int
  proximoKm        Int
  activo           Boolean  @default(true)
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  truck            Truck    @relation(fields: [truckId], references: [id], onDelete: Cascade)

  @@index([companyId, truckId, activo])
}

model MaintenanceRecord {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  companyId   String
  truckId     String
  fecha       DateTime
  tipo        String
  kilometraje Int
  costo       Decimal  @db.Decimal(12, 2)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  truck       Truck    @relation(fields: [truckId], references: [id])

  @@index([companyId, fecha])
  @@index([companyId, truckId])
}

enum Role {
  ADMIN
  USER
}

enum TruckStatus {
  ACTIVO
  INACTIVO
  TALLER
  VENDIDO
}

enum FreightStatus {
  PENDIENTE
  COMPLETADO
  ANULADO
}

enum ClientType {
  EMPRESA
  AGENCIA
  EVENTUAL
}

enum ClientStatus {
  ACTIVO
  INACTIVO
}

enum OperationalPointType {
  BALANZA
  PLANTA
  MINA
  PUERTO
  ALMACEN
  OTRO
}

enum TruckOperationMode {
  DIRECTO
  ALQUILER
}

enum TruckPaymentType {
  VUELTA
  MENSUAL
}

enum FreightModelType {
  DUENO_PAGA
  CHOFER_PAGA
}

enum FreightCalcType {
  VIAJE
  IDA_VUELTA
  MENSUAL
}

enum PaymentDirection {
  POR_PAGAR
  POR_COBRAR
}
